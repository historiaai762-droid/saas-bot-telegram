<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Telegram Premium - Painel de Controle</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0a0e1a; min-height: 100vh; padding: 20px; color: white; user-select: none; }
        .container { max-width: 1600px; margin: 0 auto; }
        .header { background: linear-gradient(135deg, #1a1f2e 0%, #0a0e1a 100%); border-radius: 20px; padding: 30px; margin-bottom: 25px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); border: 1px solid rgba(255, 215, 0, 0.3); text-align: center; }
        .logo-container img { width: 160px; height: auto; filter: drop-shadow(0 15px 40px rgba(255, 215, 0, 0.5)); animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-15px); } }
        h1 { background: linear-gradient(135deg, #ffd700 0%, #ffed4e 50%, #ffd700 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 2.2em; font-weight: 900; animation: goldShine 3s linear infinite; margin-bottom: 8px; }
        @keyframes goldShine { 0% { background-position: 0% center; } 100% { background-position: 200% center; } }
        .main-layout { display: grid; grid-template-columns: 380px 1fr 380px; gap: 20px; margin-bottom: 20px; }
        .section { background: linear-gradient(135deg, #1a1f2e 0%, #0a0e1a 100%); padding: 25px; border-radius: 15px; border: 1px solid rgba(185, 255, 0, 0.15); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid rgba(185, 255, 0, 0.1); }
        .btn { background: linear-gradient(135deg, #b9ff00 0%, #00ff88 100%); color: #0a0e1a; padding: 12px 24px; border: none; border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 700; transition: all 0.3s; width: 100%; margin-bottom: 8px; }
        .btn-danger { background: linear-gradient(135deg, #ff0055 0%, #ff5500 100%); color: white; }
        .btn-success { background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%); color: #0a0e1a; }
        input, textarea, select { width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid rgba(185, 255, 0, 0.2); border-radius: 10px; background: rgba(26, 31, 46, 0.8); color: #fff; }
        .status { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; border-radius: 25px; font-size: 13px; font-weight: 600; margin-bottom: 15px; }
        .status.offline { background: #ff0055; color: white; }
        .status.online { background: #b9ff00; color: #0a0e1a; }
        .log { background: #0a0a0a; color: #00ff00; padding: 15px; border-radius: 10px; height: 200px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 11px; border: 1px solid rgba(185, 255, 0, 0.1); }
        .log-entry { margin-bottom: 5px; }
        .notification-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 12px; }
        .notification { background: #1a1f2e; border-radius: 16px; padding: 16px 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.6); display: flex; gap: 12px; min-width: 320px; animation: slideIn 0.4s ease; border-left: 4px solid #b9ff00; }
        @keyframes slideIn { from { transform: translateX(400px); } to { transform: translateX(0); } }
        .schedule-box { background: rgba(255, 215, 0, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 2px solid rgba(255, 215, 0, 0.3); }
        .schedule-fields { display: none; } .schedule-fields.active { display: block; }
        .post-item { background: rgba(26, 31, 46, 0.6); border: 1px solid rgba(185, 255, 0, 0.2); border-radius: 12px; padding: 12px; margin-bottom: 10px; }
        @media (max-width: 1400px) { .main-layout { grid-template-columns: 1fr 1fr; } }
    </style>
</head>
<body oncontextmenu="return false;">
    <div class="notification-container" id="notificationContainer"></div>
    <div class="container">
        <div class="header">
            <div class="logo-container"><img src="https://i.ibb.co/bR1dHts5/telegram-bot-premium.png" alt="Bot Logo"></div>
            <h1>ğŸ¤– Bot Telegram Premium</h1>
            <p style="color:#888; text-transform: uppercase; letter-spacing: 2px; font-size: 0.8em;">Sistema Profissional de Agendamento</p>
        </div>

        <div class="main-layout">
            <!-- CONFIGURAÃ‡ÃƒO -->
            <div class="left-column">
                <div class="section">
                    <div class="section-header"><h2>âš™ï¸ ConfiguraÃ§Ã£o</h2></div>
                    <label>Perfil Ativo</label>
                    <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                        <select id="seletorPerfil" onchange="carregarPerfil()"></select>
                        <button class="btn btn-small btn-success" onclick="salvarPerfil()" style="width:50px">ğŸ’¾</button>
                        <button class="btn btn-small" onclick="renomearPerfil()" style="width:50px">âœï¸</button>
                    </div>
                    <label>Token do Bot:</label>
                    <input type="password" id="botToken" placeholder="Token do BotFather">
                    <button class="btn btn-success" onclick="testarConexao()">ğŸ”— Testar ConexÃ£o</button>
                    <label>Chat ID:</label>
                    <input type="text" id="chatId" placeholder="Chat ID do Canal">
                    <button class="btn" onclick="descobrirChatId()">ğŸ” Descobrir Chat ID</button>
                    <label>Intervalo (minutos):</label>
                    <input type="number" id="intervalo" value="60">
                </div>
                <div class="section">
                    <div class="section-header"><h2>ğŸ® Controles</h2></div>
                    <div class="status offline" id="status">Offline</div>
                    <button class="btn" id="startBtn" onclick="iniciarBot()">â–¶ï¸ Iniciar Bot</button>
                    <button class="btn btn-danger" id="stopBtn" disabled onclick="pararBot()">â¹ï¸ Parar Bot</button>
                    <div class="stats-grid" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px; font-size:0.8em; text-align:center;">
                        <div style="background:#1a1f2e; padding:10px; border-radius:10px;">Enviados: <span id="postsEnviados">0</span></div>
                        <div style="background:#1a1f2e; padding:10px; border-radius:10px;">Agendados: <span id="agendados">0</span></div>
                        <div style="background:#1a1f2e; padding:10px; border-radius:10px; grid-column: span 2;">Tempo: <span id="tempoRodando">00:00:00</span></div>
                    </div>
                </div>
            </div>

            <!-- CRIAR POST -->
            <div class="center-column">
                <div class="section">
                    <div class="section-header"><h2>â• Criar Post</h2></div>
                    <select id="tipoPost" onchange="atualizarCampos()">
                        <option value="texto">ğŸ“ Texto</option>
                        <option value="imagem">ğŸ–¼ï¸ Imagem</option>
                        <option value="video">ğŸ¥ VÃ­deo</option>
                    </select>
                    <div id="campoTexto"><textarea id="mensagemTexto" placeholder="Mensagem..." rows="4"></textarea></div>
                    <div id="campoArquivo" style="display:none;">
                        <input type="file" id="arquivo" onchange="previewArquivo()">
                        <div id="preview"></div>
                        <textarea id="legenda" placeholder="Legenda..."></textarea>
                    </div>
                    <div class="schedule-box">
                        <label style="cursor:pointer;"><input type="checkbox" id="agendarPost" onchange="toggleAgendamento()"> ğŸ• Agendar Postagem</label>
                        <div id="scheduleFields" class="schedule-fields" style="margin-top:10px">
                            <select id="tipoAgendamento" onchange="atualizarCamposAgendamento()">
                                <option value="unico">ğŸ“… Data Ãšnica</option>
                                <option value="diario">ğŸ”„ DiÃ¡rio</option>
                                <option value="semanal">ğŸ“† Semanal</option>
                                <option value="mensal">ğŸ“Š Mensal</option>
                            </select>
                            <input type="date" id="dataAgendamento">
                            <input type="time" id="horaAgendamento">
                            <select id="diaSemana" style="display:none"><option value="0">Domingo</option><option value="1">Segunda</option><option value="2">TerÃ§a</option><option value="3">Quarta</option><option value="4">Quinta</option><option value="5">Sexta</option><option value="6">SÃ¡bado</option></select>
                            <input type="number" id="diaMes" style="display:none" min="1" max="31" placeholder="Dia do MÃªs">
                        </div>
                    </div>
                    <button class="btn" onclick="adicionarPost()">â• Adicionar Ã  Fila</button>
                </div>
                <div class="section">
                    <div class="section-header"><h2>ğŸ“Š Log do Sistema</h2><button class="btn btn-small" style="width:auto" onclick="limparLog()">ğŸ—‘ï¸</button></div>
                    <div class="log" id="log"></div>
                </div>
            </div>

            <!-- FILA E TEMPLATES -->
            <div class="right-column">
                <div class="section">
                    <div class="section-header"><h2>ğŸ“‹ Fila</h2><span id="totalPosts" class="section-badge">0</span></div>
                    <div id="filaPosts" style="max-height:250px; overflow-y:auto"></div>
                    <button class="btn btn-danger btn-small" onclick="limparFila()">ğŸ—‘ï¸ Limpar Fila</button>
                </div>
                <div class="section">
                    <div class="section-header"><h2>ğŸ• Agendados</h2><span id="totalAgendados" class="section-badge">0</span></div>
                    <div id="filaAgendados" style="max-height:200px; overflow-y:auto"></div>
                </div>
                <div class="section">
                    <div class="section-header"><h2>ğŸ¨ Templates</h2></div>
                    <div id="listaTemplates"></div>
                    <button class="btn btn-small" onclick="salvarTemplate()">ğŸ’¾ Salvar Atual</button>
                </div>
                <div class="section">
                    <div class="section-header"><h2>ğŸ“¤ Backup</h2></div>
                    <button class="btn btn-success" onclick="exportarConfiguracao()">ğŸ“¥ Exportar</button>
                    <input type="file" id="importFile" style="display:none" onchange="importarConfiguracao(event)">
                    <button class="btn" onclick="document.getElementById('importFile').click()">ğŸ“¤ Importar</button>
                    <button class="btn btn-danger" onclick="logout()" style="background:none; border:1px solid #444; color:#888; margin-top:10px;">Sair da Conta</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        /* PROTEÃ‡ÃƒO DE INTERFACE */
        document.addEventListener('keydown',function(e){if(e.ctrlKey&&(e.key==='u'||e.key==='s'||e.key==='i')||e.keyCode===123)e.preventDefault();});

        /* 1. SEGURANÃ‡A SUPABASE (NÃƒO MEXER) */
        const supabaseUrl="https://zyjeriulpozkvhtxdvrx.supabase.co";
        const supabaseKey="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp5amVyaXVscG96a3ZodHhkdnJ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MzM3NzQsImV4cCI6MjA4NDAwOTc3NH0.dFcbSg8JOlO0sSvU1bz-a1rpyh8p5LoUpLddetHkGZI"; 
        const _supabase=supabase.createClient(supabaseUrl,supabaseKey);
        async function verificarAcesso(){const {data:{user}}=await _supabase.auth.getUser();if(!user){window.location.href="login.html";return;}const {data:subs}=await _supabase.from('subscriptions').select('status,expires_at').eq('user_id',user.email.trim().toLowerCase());const sub=subs&&subs.length>0?subs[0]:null;const agora=new Date();const dataExp=sub?new Date(sub.expires_at):null;if(!sub||sub.status!=='active'||(dataExp&&dataExp<agora)){document.body.innerHTML=`<div style="text-align:center;margin-top:100px;background:#0a0e1a;height:100vh"><h1>ğŸš« Acesso Negado</h1><p>Assinatura Inativa.</p><br><a href="index.html" style="color:#b9ff00">Ver Planos</a><button onclick="logout()" style="color:gray;background:none;border:none;text-decoration:underline;cursor:pointer;margin-top:20px;">Sair</button></div>`;return;}}verificarAcesso();
        async function logout(){await _supabase.auth.signOut();window.location.href="login.html";}

        /* 2. LÃ“GICA DO BOT COMPLETA E PROTEGIDA (RESTAURADA) */
        let botAtivo=false,intervaloId=null,checkAgendadosId=null,postsEnviados=0,inicioBot=null,tempoRodandoId=null,filaDePosts=[],filaOriginal=[],postsAgendados=[],templates=[],perfilAtual='perfil1';
        const notificationIcons={success:'âœ”',error:'âœ•',warning:'!',info:'i'};
        function showNotification(t='info',ti='',m='',d=5000){const c=document.getElementById('notificationContainer');const n=document.createElement('div');const id='notif-'+Date.now();n.className=`notification ${t}`;n.id=id;n.innerHTML=`<div class="notification-content"><strong>${ti}</strong><br>${m}</div>`;c.appendChild(n);setTimeout(()=>n.remove(),d);}
        function log(msg,tipo='info'){const logDiv=document.getElementById('log');const time=new Date().toLocaleTimeString('pt-BR');logDiv.innerHTML+=`<div class="log-entry">[${time}] ${msg}</div>`;logDiv.scrollTop=logDiv.scrollHeight;}
        window.onload=()=>{carregarDados();carregarPerfil();atualizarSeletorPerfis();setInterval(verificarAgendados,30000);};
        function carregarDados(){const d=JSON.parse(localStorage.getItem('telegram_bot_data')||'{}');postsAgendados=d.agendados||[];templates=d.templates||[];atualizarFilaAgendados();atualizarListaTemplates();}
        function salvarDados(){localStorage.setItem('telegram_bot_data',JSON.stringify({agendados:postsAgendados,templates}));}
        function atualizarSeletorPerfis(){const s=document.getElementById('seletorPerfil');s.innerHTML='';for(let i=1;i<=10;i++){const config=JSON.parse(localStorage.getItem(`telegram_perfil${i}`)||'{}');const opt=document.createElement('option');opt.value=`perfil${i}`;opt.textContent=config.nome||`Perfil ${i}`;s.appendChild(opt);}s.value=perfilAtual;}
        function carregarPerfil(){perfilAtual=document.getElementById('seletorPerfil').value;const c=JSON.parse(localStorage.getItem(`telegram_${perfilAtual}`)||'{}');document.getElementById('botToken').value=c.token||'';document.getElementById('chatId').value=c.chatId||'';document.getElementById('intervalo').value=c.intervalo||60;log(`Perfil ${perfilAtual} carregado.`);}
        function salvarPerfil(){const d={nome:perfilAtual,token:document.getElementById('botToken').value.trim(),chatId:document.getElementById('chatId').value.trim(),intervalo:document.getElementById('intervalo').value};localStorage.setItem(`telegram_${perfilAtual}`,JSON.stringify(d));showNotification('success','Sucesso','Perfil Salvo.');}
        function renomearPerfil(){const n=prompt('Nome do Grupo/Canal:');if(n&&n.trim()){const c=JSON.parse(localStorage.getItem(`telegram_${perfilAtual}`)||'{}');c.nome=n.trim();localStorage.setItem(`telegram_${perfilAtual}`,JSON.stringify(c));atualizarSeletorPerfis();}}
        function atualizarCampos(){const t=document.getElementById('tipoPost').value;document.getElementById('campoTexto').style.display=t==='texto'?'block':'none';document.getElementById('campoArquivo').style.display=t!=='texto'?'block':'none';}
        function toggleAgendamento(){document.getElementById('scheduleFields').classList.toggle('active',document.getElementById('agendarPost').checked);}
        function atualizarCamposAgendamento(){const t=document.getElementById('tipoAgendamento').value;document.getElementById('diaSemana').style.display=t==='semanal'?'block':'none';document.getElementById('diaMes').style.display=t==='mensal'?'block':'none';}
        function calcularProximaExecucao(ag){const agora=new Date();let prox=new Date();switch(ag.tipo){case 'unico':prox=new Date(ag.data+' '+ag.hora);break;case 'diario':const[h,m]=ag.hora.split(':');prox.setHours(h,m,0,0);if(prox<=agora)prox.setDate(prox.getDate()+1);break;case 'semanal':const[hs,ms]=ag.hora.split(':');prox.setHours(hs,ms,0,0);let diff=parseInt(ag.diaSemana)-prox.getDay();if(diff<0||(diff===0&&prox<=agora))diff+=7;prox.setDate(prox.getDate()+diff);break;case 'mensal':const[hm,mm]=ag.hora.split(':');prox.setDate(parseInt(ag.diaMes));prox.setHours(hm,mm,0,0);if(prox<=agora)prox.setMonth(prox.getMonth()+1);break;}return prox;}
        function verificarAgendados(){const agora=new Date();postsAgendados.forEach((a,i)=>{const prox=calcularProximaExecucao(a.agendamento);if(prox<=agora&&agora-prox<60000){enviarPost(a.post);if(a.agendamento.tipo==='unico')postsAgendados.splice(i,1);salvarDados();atualizarFilaAgendados();}});}
        function adicionarPost(){const t=document.getElementById('tipoPost').value,p={tipo:t,mensagem:document.getElementById('mensagemTexto').value,legenda:document.getElementById('legenda').value,id:Date.now()};if(document.getElementById('agendarPost').checked){const ag={tipo:document.getElementById('tipoAgendamento').value,data:document.getElementById('dataAgendamento').value,hora:document.getElementById('horaAgendamento').value,diaSemana:document.getElementById('diaSemana').value,diaMes:document.getElementById('diaMes').value};postsAgendados.push({post:p,agendamento:ag});salvarDados();atualizarFilaAgendados();showNotification('success','Agendado','Post salvo.');}else{filaDePosts.push(p);filaOriginal.push(p);atualizarFila();log('Adicionado Ã  fila.');}}
        function atualizarFila(){document.getElementById('totalPosts').textContent=filaDePosts.length;document.getElementById('filaPosts').innerHTML=filaDePosts.map((p,i)=>`<div class="post-item">#${i+1} [${p.tipo}] <button onclick="filaDePosts.splice(${i},1);atualizarFila();" style="float:right">ğŸ—‘ï¸</button></div>`).join('');}
        function atualizarFilaAgendados(){document.getElementById('totalAgendados').textContent=postsAgendados.length;document.getElementById('filaAgendados').innerHTML=postsAgendados.map((a,i)=>`<div class="post-item">${a.agendamento.hora} - ${a.post.tipo} <button onclick="postsAgendados.splice(${i},1);salvarDados();atualizarFilaAgendados();" style="float:right">ğŸ—‘ï¸</button></div>`).join('');}
        async function testarConexao(){const t=document.getElementById('botToken').value;try{const r=await fetch(`https://api.telegram.org/bot${t}/getMe`);const d=await r.json();if(d.ok)showNotification('success','Sucesso',`Bot @${d.result.username} conectado!`);else showNotification('error','Erro','Token invÃ¡lido.');}catch(e){showNotification('error','Erro','Falha na conexÃ£o.');}}
        async function descobrirChatId(){const t=document.getElementById('botToken').value;try{const r=await fetch(`https://api.telegram.org/bot${t}/getUpdates`);const d=await r.json();if(d.result?.length>0){const id=d.result[d.result.length-1].message?.chat?.id;if(id){document.getElementById('chatId').value=id;showNotification('success','ID Encontrado',id);}}else{showNotification('warning','Aviso','Envie uma mensagem no grupo primeiro.');}}catch(e){}}
        function iniciarBot(){if(filaDePosts.length===0&&postsAgendados.length===0){showNotification('error','Erro','Fila vazia.');return;}botAtivo=true;document.getElementById('status').className='status online';document.getElementById('status').innerHTML='Online';document.getElementById('startBtn').disabled=true;document.getElementById('stopBtn').disabled=false;inicioBot=Date.now();tempoRodandoId=setInterval(atualizarTempo,1000);const min=parseInt(document.getElementById('intervalo').value)*60000;intervaloId=setInterval(enviarProximo,min);enviarProximo();}
        async function enviarProximo(){if(!botAtivo)return;if(filaDePosts.length===0)filaDePosts=[...filaOriginal];if(filaDePosts.length>0){const p=filaDePosts.shift();enviarPost(p);atualizarFila();}}
        async function enviarPost(p){const t=document.getElementById('botToken').value,c=document.getElementById('chatId').value;try{if(p.tipo==='texto')await fetch(`https://api.telegram.org/bot${t}/sendMessage`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({chat_id:c,text:p.mensagem})});else{const fd=new FormData();fd.append('chat_id',c);if(p.legenda)fd.append('caption',p.legenda);const met=p.tipo==='imagem'?'sendPhoto':'sendVideo';fd.append(p.tipo==='imagem'?'photo':'video',p.arquivo);await fetch(`https://api.telegram.org/bot${t}/${met}`,{method:'POST',body:fd});}postsEnviados++;document.getElementById('postsEnviados').textContent=postsEnviados;log('Post enviado com sucesso.','success');}catch(e){log('Erro ao enviar post.','error');}}
        function pararBot(){botAtivo=false;clearInterval(intervaloId);clearInterval(tempoRodandoId);document.getElementById('status').className='status offline';document.getElementById('status').innerHTML='Offline';document.getElementById('startBtn').disabled=false;document.getElementById('stopBtn').disabled=true;}
        function atualizarTempo(){const d=new Date(Date.now()-inicioBot);document.getElementById('tempoRodando').textContent=d.toISOString().substr(11,8);}
        function limparLog(){document.getElementById('log').innerHTML='';}
        function limparFila(){filaDePosts=[];filaOriginal=[];atualizarFila();}
        function previewArquivo(){const f=document.getElementById('arquivo').files[0];if(f){const r=new FileReader();r.onload=(e)=>{const t=document.getElementById('tipoPost').value;document.getElementById('preview').innerHTML=t==='imagem'?`<img src="${e.target.result}" style="max-width:100px; border-radius:5px">`:`<video src="${e.target.result}" style="max-width:100px" controls></video>`};r.readAsDataURL(f);}}
        function salvarTemplate(){const t=document.getElementById('mensagemTexto').value;if(!t)return;const n=prompt('Nome do Template:');if(n){templates.push({nome:n,msg:t});salvarDados();atualizarListaTemplates();}}
        function atualizarListaTemplates(){document.getElementById('listaTemplates').innerHTML=templates.map((t,i)=>`<div class="post-item">${t.nome} <button onclick="document.getElementById('mensagemTexto').value='${t.msg}';showNotification('info','Template','Texto carregado');" style="float:right">ğŸ“‹</button><button onclick="templates.splice(${i},1);salvarDados();atualizarListaTemplates();" style="float:right; margin-right:5px;">ğŸ—‘ï¸</button></div>`).join('');}
        function exportarConfiguracao(){const d=localStorage.getItem('telegram_bot_data');const b=new Blob([d],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='bot_backup.json';a.click();}
        function importarConfiguracao(e){const r=new FileReader();r.onload=(ev)=>{localStorage.setItem('telegram_bot_data',ev.target.result);location.reload();};r.readAsText(e.target.files[0]);}
    </script>
</body>
</html>
